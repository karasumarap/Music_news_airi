"""
éŸ³æ¥½ãƒ‹ãƒ¥ãƒ¼ã‚¹AI - 4æ§‹é€ å¤‰æ›ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«
ãƒ‹ãƒ¥ãƒ¼ã‚¹ã‚’Fact/Meaning/Impact/Questionã®4æ§‹é€ ã«å¤‰æ›ã™ã‚‹
"""

import logging
from typing import Dict, Any, List

logger = logging.getLogger(__name__)


class StructureConverter:
    """ãƒ‹ãƒ¥ãƒ¼ã‚¹ã‚’4æ§‹é€ ã«å¤‰æ›ã™ã‚‹ã‚¯ãƒ©ã‚¹"""
    
    def convert(self, news: Dict[str, Any]) -> Dict[str, Any]:
        """
        ãƒ‹ãƒ¥ãƒ¼ã‚¹ã‚’4æ§‹é€ ã«å¤‰æ›ã™ã‚‹
        
        Args:
            news: ãƒ‹ãƒ¥ãƒ¼ã‚¹ãƒ‡ãƒ¼ã‚¿
            
        Returns:
            4æ§‹é€ åŒ–ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿
        """
        logger.info("ğŸ”„ ãƒ‹ãƒ¥ãƒ¼ã‚¹ã‚’4æ§‹é€ ã«å¤‰æ›ã—ã¾ã™")
        
        structured = {
            "original_news": {
                "title": news.get("title", ""),
                "date": news.get("date", ""),
                "source": news.get("source", ""),
            },
            "fact": self._extract_fact(news),
            "meaning": self._extract_meaning(news),
            "impact": self._extract_impact(news),
            "question": self._extract_question(news),
        }
        
        logger.info("âœ… 4æ§‹é€ ã¸ã®å¤‰æ›ãŒå®Œäº†ã—ã¾ã—ãŸ")
        return structured
    
    def _extract_fact(self, news: Dict[str, Any]) -> Dict[str, Any]:
        """
        Factï¼ˆä½•ãŒèµ·ããŸã‹ï¼‰ã‚’æŠ½å‡ºã™ã‚‹ï¼ˆãƒ¢ãƒƒã‚¯å®Ÿè£…ï¼‰
        
        å®Ÿéš›ã®APIå®Ÿè£…ã§ã¯ã€LLMã‚’ä½¿ã£ã¦æ§‹é€ åŒ–ã™ã‚‹
        """
        content = news.get("content", "")
        title = news.get("title", "")
        
        # ã‚µãƒ³ãƒ—ãƒ«ãƒ‹ãƒ¥ãƒ¼ã‚¹ã«ç‰¹åŒ–ã—ãŸæŠ½å‡ºï¼ˆãƒ¢ãƒƒã‚¯ï¼‰
        if "å†ç”Ÿå¯èƒ½ã‚¨ãƒãƒ«ã‚®ãƒ¼" in title:
            return {
                "summary": "æ—¥æœ¬æ”¿åºœã¯2026å¹´1æœˆ9æ—¥ã€2030å¹´ã¾ã§ã®å†ç”Ÿå¯èƒ½ã‚¨ãƒãƒ«ã‚®ãƒ¼æ¯”ç‡ã®ç›®æ¨™ã‚’å¾“æ¥ã®30%ã‹ã‚‰40%ã«å¼•ãä¸Šã’ã‚‹ã¨ç™ºè¡¨ã—ãŸã€‚",
                "details": [
                    "æ”¿åºœãŒ2030å¹´ã¾ã§ã®å†ç”Ÿå¯èƒ½ã‚¨ãƒãƒ«ã‚®ãƒ¼æ¯”ç‡ã®ç›®æ¨™ã‚’40%ã«è¨­å®š",
                    "å¾“æ¥ã®ç›®æ¨™ã¯30%ã ã£ãŸ",
                    "å¤ªé™½å…‰ç™ºé›»ã¨é¢¨åŠ›ç™ºé›»ã‚’ä¸­å¿ƒã«ã‚¤ãƒ³ãƒ•ãƒ©æ•´å‚™ã‚’åŠ é€Ÿ",
                    "çµŒæ¸ˆç”£æ¥­çœãŒæ–¹é‡ã‚’ç™ºè¡¨"
                ]
            }
        else:
            # æ±ç”¨çš„ãªæŠ½å‡ºï¼ˆç°¡æ˜“ç‰ˆï¼‰
            return {
                "summary": title,
                "details": [
                    content[:100] + "..." if len(content) > 100 else content
                ]
            }
    
    def _extract_meaning(self, news: Dict[str, Any]) -> Dict[str, Any]:
        """
        Meaningï¼ˆä½•ã‚’æ„å‘³ã™ã‚‹ã‹ï¼‰ã‚’æŠ½å‡ºã™ã‚‹ï¼ˆãƒ¢ãƒƒã‚¯å®Ÿè£…ï¼‰
        """
        title = news.get("title", "")
        
        if "å†ç”Ÿå¯èƒ½ã‚¨ãƒãƒ«ã‚®ãƒ¼" in title:
            return {
                "summary": "ã“ã‚Œã¯æ—¥æœ¬ãŒè„±ç‚­ç´ ç¤¾ä¼šã®å®Ÿç¾ã«å‘ã‘ã¦å¤§ããèˆµã‚’åˆ‡ã£ãŸã“ã¨ã‚’æ„å‘³ã™ã‚‹ã€‚",
                "context": "ä¸–ç•Œçš„ã«æ°—å€™å¤‰å‹•å¯¾ç­–ãŒæ€¥å‹™ã¨ãªã‚‹ä¸­ã€æ—¥æœ¬ã‚‚ã‚¨ãƒãƒ«ã‚®ãƒ¼æ”¿ç­–ã‚’å¤§ããè»¢æ›ã€‚ã“ã‚Œã¾ã§ã®åŒ–çŸ³ç‡ƒæ–™ä¾å­˜ã‹ã‚‰ã€æŒç¶šå¯èƒ½ãªã‚¨ãƒãƒ«ã‚®ãƒ¼ã¸ã®ç§»è¡Œã‚’åŠ é€Ÿã•ã›ã‚‹æ–¹é‡ã€‚"
            }
        else:
            return {
                "summary": "ã“ã®ãƒ‹ãƒ¥ãƒ¼ã‚¹ã¯ç¤¾ä¼šã«é‡è¦ãªå½±éŸ¿ã‚’ä¸ãˆã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ã€‚",
                "context": "è©³ç´°ãªåˆ†æãŒå¿…è¦ã€‚"
            }
    
    def _extract_impact(self, news: Dict[str, Any]) -> Dict[str, Any]:
        """
        Impactï¼ˆèª°ã«ã©ã†å½±éŸ¿ã™ã‚‹ã‹ï¼‰ã‚’æŠ½å‡ºã™ã‚‹ï¼ˆãƒ¢ãƒƒã‚¯å®Ÿè£…ï¼‰
        """
        title = news.get("title", "")
        
        if "å†ç”Ÿå¯èƒ½ã‚¨ãƒãƒ«ã‚®ãƒ¼" in title:
            return {
                "positive": [
                    "é•·æœŸçš„ã«ã¯ã‚¨ãƒãƒ«ã‚®ãƒ¼ã®å®‰å®šä¾›çµ¦ãŒæœŸå¾…ã§ãã‚‹",
                    "å†ç”Ÿå¯èƒ½ã‚¨ãƒãƒ«ã‚®ãƒ¼é–¢é€£ã®ä»•äº‹ãŒå¢—ãˆã‚‹å¯èƒ½æ€§",
                    "ç’°å¢ƒã¸ã®è² è·ãŒæ¸›ã‚Šã€æœªæ¥ã®åœ°çƒç’°å¢ƒãŒæ”¹å–„ã•ã‚Œã‚‹å¯èƒ½æ€§",
                    "ã‚¨ãƒãƒ«ã‚®ãƒ¼è‡ªçµ¦ç‡ãŒå‘ä¸Šã—ã€å›½éš›æƒ…å‹¢ã®å½±éŸ¿ã‚’å—ã‘ã«ãããªã‚‹"
                ],
                "negative": [
                    "é›»åŠ›æ–™é‡‘ãŒä¸€æ™‚çš„ã«ä¸ŠãŒã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹",
                    "é€é›»ç¶²ã®æ•´å‚™ã‚³ã‚¹ãƒˆãŒç™ºç”Ÿã™ã‚‹",
                    "å¾“æ¥ã®ã‚¨ãƒãƒ«ã‚®ãƒ¼ç”£æ¥­ã§åƒãäººã€…ã®è»¢è·ãŒå¿…è¦ã«ãªã‚‹ã‹ã‚‚ã—ã‚Œãªã„"
                ],
                "uncertain": [
                    "å…·ä½“çš„ãªé›»æ°—æ–™é‡‘ã®å¤‰å‹•å¹…ã¯ã¾ã ä¸æ˜",
                    "æŠ€è¡“é©æ–°ã®ã‚¹ãƒ”ãƒ¼ãƒ‰ã«ã‚ˆã£ã¦çµæœãŒå¤‰ã‚ã‚‹å¯èƒ½æ€§",
                    "å›½éš›çš„ãªã‚¨ãƒãƒ«ã‚®ãƒ¼æƒ…å‹¢ã®å¤‰åŒ–ã«å·¦å³ã•ã‚Œã‚‹"
                ]
            }
        else:
            return {
                "positive": ["ãƒã‚¸ãƒ†ã‚£ãƒ–ãªå½±éŸ¿ãŒäºˆæƒ³ã•ã‚Œã‚‹"],
                "negative": ["ãƒã‚¬ãƒ†ã‚£ãƒ–ãªå½±éŸ¿ã‚‚è€ƒæ…®ã™ã‚‹å¿…è¦ãŒã‚ã‚‹"],
                "uncertain": ["ä¸ç¢ºå®šè¦ç´ ãŒå­˜åœ¨ã™ã‚‹"]
            }
    
    def _extract_question(self, news: Dict[str, Any]) -> Dict[str, Any]:
        """
        Questionï¼ˆç§ãŸã¡ã¯ã©ã†å‘ãåˆã†ï¼Ÿï¼‰ã‚’æŠ½å‡ºã™ã‚‹ï¼ˆãƒ¢ãƒƒã‚¯å®Ÿè£…ï¼‰
        """
        title = news.get("title", "")
        
        if "å†ç”Ÿå¯èƒ½ã‚¨ãƒãƒ«ã‚®ãƒ¼" in title:
            return {
                "main_question": "ã‚ãŸã—ãŸã¡ã«ã§ãã‚‹ã“ã¨ã£ã¦ã€ä½•ã ã‚ã†ï¼Ÿ",
                "sub_questions": [
                    "ç¯€é›»ã™ã‚‹ã“ã¨ã‚‚ã€å°ã•ãªä¸€æ­©ã‹ã‚‚ã—ã‚Œãªã„",
                    "å†ç”Ÿå¯èƒ½ã‚¨ãƒãƒ«ã‚®ãƒ¼ã«ã¤ã„ã¦ã€ã‚‚ã£ã¨å­¦ã‚“ã§ã¿ã‚‹ï¼Ÿ",
                    "å°†æ¥ã€ã‚¨ãƒãƒ«ã‚®ãƒ¼é–¢é€£ã®ä»•äº‹ã«èˆˆå‘³ã‚’æŒã¤ã“ã¨ã‚‚ã§ãã‚‹ã‹ã‚‚",
                    "ä¸€ç·’ã«ã€æŒç¶šå¯èƒ½ãªæœªæ¥ã‚’è€ƒãˆã¦ã„ã“ã†"
                ]
            }
        else:
            return {
                "main_question": "ã“ã®ãƒ‹ãƒ¥ãƒ¼ã‚¹ã«ã¤ã„ã¦ã€ã©ã†è€ƒãˆã‚‹ï¼Ÿ",
                "sub_questions": [
                    "ä¸€ç·’ã«è€ƒãˆã¦ã¿ã‚ˆã†",
                    "è‰²ã€…ãªè¦–ç‚¹ãŒã‚ã‚‹ã‹ã‚‚ã—ã‚Œãªã„"
                ]
            }


# ä¾¿åˆ©é–¢æ•°
def convert_to_structure(news: Dict[str, Any]) -> Dict[str, Any]:
    """
    ãƒ‹ãƒ¥ãƒ¼ã‚¹ã‚’4æ§‹é€ ã«å¤‰æ›ã™ã‚‹ï¼ˆä¾¿åˆ©é–¢æ•°ï¼‰
    
    Args:
        news: ãƒ‹ãƒ¥ãƒ¼ã‚¹ãƒ‡ãƒ¼ã‚¿
        
    Returns:
        4æ§‹é€ åŒ–ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿
    """
    converter = StructureConverter()
    return converter.convert(news)
